# Next.js 项目自动构建与部署系统需求文档

## 1. 项目概述

本项目旨在开发一个自动化工具，用于构建 Next.js 项目、创建 Docker 镜像并将其部署到远程服务器。该工具应支持多种包管理器（yarn、npm、pnpm），并能根据项目配置构建兼容 Linux 系统的 Docker 镜像，然后通过 SSH 上传到指定服务器并自动更新服务。

## 2. 目标用户

- DevOps 工程师
- 前端开发人员
- CI/CD 流程管理人员

## 3. 核心功能需求

### 3.1 项目构建
- 支持进入指定的 Next.js 项目目录
- 支持使用 yarn、npm 或 pnpm 进行项目构建
- 支持自定义编译命令

### 3.2 Docker 镜像构建
- 根据项目中的 Docker 配置构建镜像
- 构建的 Docker 镜像需兼容 Linux 系统
- 镜像文件命名需体现版本信息

### 3.3 镜像上传与管理
- 通过 SSH 上传镜像到远程服务器
- 上传到指定的历史镜像管理目录
- 支持镜像版本管理

### 3.4 服务更新与回滚
- 在远程服务器上停止原有容器服务
- 卸载原有镜像
- 载入最新版本镜像
- 运行指定目录下的 Docker Compose 命令重启服务
- 若新镜像启动失败，能自动回滚到前一版本并重启服务

## 4. 配置参数

系统在流程开始时需支持配置以下关键参数：

1. 项目目录：Next.js 项目的本地路径
2. 项目编译命令：用于构建项目的命令（如 `yarn build`）
3. 远程服务器信息：包括服务器地址、SSH 认证信息
4. 远程服务器的镜像目录：存储历史镜像文件的目录路径
5. 远程服务器的 Docker Compose 目录：包含 docker-compose.yml 文件的目录路径

## 5. 系统流程节点

1. **配置节点**：接收并验证所有必要配置参数
2. **执行编译节点**：在本地执行项目构建命令
3. **构建镜像节点**：根据项目 Docker 配置创建镜像
4. **上传镜像节点**：通过 SSH 将镜像上传到远程服务器
5. **重新载入远程镜像和服务节点**：在远程服务器上更新服务
6. **回滚节点**：当新版本启动失败时，自动回滚到前一版本

## 6. 技术要求

- 支持多种包管理器（yarn、npm、pnpm）
- Docker 镜像需兼容 Linux 系统
- 通过 SSH 安全连接远程服务器
- 支持 Docker Compose 服务管理
- 具备版本管理和自动回滚能力

## 7. 特殊需求

- 镜像文件命名需包含版本信息以便管理
- 新镜像启动失败时必须能自动回滚到前一版本
- 系统应具备错误处理和日志记录功能